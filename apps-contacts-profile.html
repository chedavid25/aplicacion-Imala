<!doctype html>
<html lang="es">

<head>
    <meta charset="utf-8" />
    <title>Mi Perfil | Imalá</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    <!-- App favicon -->
    <link rel="shortcut icon" href="assets/images/favicon.ico">

    <!-- preloader css -->
    <link rel="stylesheet" href="assets/css/preloader.min.css" type="text/css" />

    <!-- Bootstrap Css -->
    <link href="assets/css/bootstrap.min.css" id="bootstrap-style" rel="stylesheet" type="text/css" />
    <!-- Icons Css -->
    <link href="assets/css/icons.min.css" rel="stylesheet" type="text/css" />
    <!-- App Css-->
    <link href="assets/css/app.min.css" id="app-style" rel="stylesheet" type="text/css" />
</head>

<body>
    <div id="layout-wrapper">

        <!-- Topbar -->
        <header id="page-topbar">
            <div class="navbar-header">
                <div class="d-flex">
                    <!-- LOGO -->
                    <div class="navbar-brand-box">
                        <a href="index.html" class="logo logo-dark">
                            <span class="logo-sm">
                                <img src="assets/images/logo-sm.svg" alt="" height="24">
                            </span>
                            <span class="logo-lg">
                                <img src="assets/images/logo-sm.svg" alt="" height="24">
                                <span class="logo-txt">Imalá</span>
                            </span>
                        </a>

                        <a href="index.html" class="logo logo-light">
                            <span class="logo-sm">
                                <img src="assets/images/logo-sm.svg" alt="" height="24">
                            </span>
                            <span class="logo-lg">
                                <img src="assets/images/logo-sm.svg" alt="" height="24">
                                <span class="logo-txt">Imalá</span>
                            </span>
                        </a>
                    </div>

                    <button type="button" class="btn btn-sm px-3 font-size-16 header-item" id="vertical-menu-btn">
                        <i class="fa fa-fw fa-bars"></i>
                    </button>
                </div>

                <div class="d-flex">
                    <div class="dropdown d-inline-block">
                        <button type="button" class="btn header-item bg-light-subtle border-start border-end"
                            id="page-header-user-dropdown" data-bs-toggle="dropdown" aria-haspopup="true"
                            aria-expanded="false">
                            <img class="rounded-circle header-profile-user" src="assets/images/users/avatar-1.jpg"
                                alt="Header Avatar" id="header-avatar">
                            <span class="d-none d-xl-inline-block ms-1 fw-medium" id="header-user-name">Agente</span>
                            <i class="mdi mdi-chevron-down d-none d-xl-inline-block"></i>
                        </button>
                        <div class="dropdown-menu dropdown-menu-end">
                            <a class="dropdown-item" href="apps-contacts-profile.html">
                                <i class="mdi mdi-face-man font-size-16 align-middle me-1"></i> Mi perfil
                            </a>
                            <div class="dropdown-divider"></div>
                            <a class="dropdown-item" href="auth-logout.html">
                                <i class="mdi mdi-logout font-size-16 align-middle me-1"></i> Cerrar sesión
                            </a>
                        </div>
                    </div>

                </div>
            </div>
        </header>
        <!-- End Topbar -->

        <!-- Sidebar -->
        <div class="vertical-menu">
            <div data-simplebar class="h-100">
                <div id="sidebar-menu">
                    <ul class="metismenu list-unstyled" id="side-menu">
                        <li class="menu-title" data-key="t-menu">Menú</li>

                        <li>
                            <a href="index.html">
                                <i data-feather="home"></i>
                                <span>Dashboard</span>
                            </a>
                        </li>

                        <li>
                            <a href="plan.html">
                                <i data-feather="target"></i>
                                <span>Planificación</span>
                            </a>
                        </li>

                        <li>
                            <a href="tracking.html">
                                <i data-feather="calendar"></i>
                                <span>Tracking semanal</span>
                            </a>
                        </li>

                        <li>
                            <a href="apps-contacts-profile.html">
                                <i data-feather="user"></i>
                                <span>Mi perfil</span>
                            </a>
                        </li>

                        <!-- Si sos admin, ya mostrás el Panel Admin desde JS en otras pantallas -->
                    </ul>
                </div>
            </div>
        </div>
        <!-- End Sidebar -->

        <!-- ============================================================== -->
        <!-- Start right Content here -->
        <!-- ============================================================== -->
        <div class="main-content">

            <div class="page-content">
                <div class="container-fluid">

                    <!-- Page title -->
                    <div class="row">
                        <div class="col-12">
                            <div class="page-title-box d-sm-flex align-items-center justify-content-between">
                                <h4 class="mb-sm-0 font-size-18">Mi perfil</h4>
                                <div class="page-title-right">
                                    <ol class="breadcrumb m-0">
                                        <li class="breadcrumb-item">
                                            <a href="index.html">Inicio</a>
                                        </li>
                                        <li class="breadcrumb-item active">Mi perfil</li>
                                    </ol>
                                </div>
                            </div>
                        </div>
                    </div>
                    <!-- end page title -->

                    <!-- Perfil -->
                    <div class="row">
                        <div class="col-xl-8 col-lg-9">
                            <div class="card">
                                <div class="card-body">

                                    <!-- Cabecera de perfil -->
                                    <div class="d-flex align-items-start mb-4">
                                        <div class="flex-shrink-0">
                                            <div class="avatar-xl me-3">
                                                <img id="profile-avatar" src="assets/images/users/avatar-2.jpg" alt=""
                                                    class="img-fluid rounded-circle d-block">
                                            </div>
                                        </div>
                                        <div class="flex-grow-1">
                                            <div>
                                                <h5 class="font-size-16 mb-1" id="profile-name">Agente</h5>
                                                <p class="text-muted font-size-13 mb-1" id="profile-email">
                                                    correo@ejemplo.com
                                                </p>
                                                <span class="badge bg-primary-subtle text-primary font-size-12">
                                                    Agente inmobiliario
                                                </span>
                                            </div>
                                        </div>
                                    </div>

                                    <hr class="my-3">

                                    <!-- Formulario de edición -->
                                    <h5 class="card-title mb-3">Editar datos personales</h5>

                                    <form id="form-perfil" novalidate>
                                        <div class="row">
                                            <div class="col-md-6">
                                                <div class="mb-3">
                                                    <label for="input-nombre" class="form-label">Nombre completo</label>
                                                    <input type="text" class="form-control" id="input-nombre"
                                                        placeholder="Nombre y apellido" required>
                                                </div>
                                            </div>

                                            <div class="col-md-6">
                                                <div class="mb-3">
                                                    <label for="input-email-login" class="form-label">Email de
                                                        login</label>
                                                    <input type="email" class="form-control" id="input-email-login"
                                                        readonly disabled>
                                                    <small class="text-muted">
                                                        Este es el email con el que iniciás sesión.
                                                    </small>
                                                </div>
                                            </div>
                                        </div>

                                        <div class="row">
                                            <div class="col-md-6">
                                                <div class="mb-3">
                                                    <label for="input-email-contacto" class="form-label">Email de
                                                        contacto</label>
                                                    <input type="email" class="form-control" id="input-email-contacto"
                                                        placeholder="Email para mostrar a clientes">
                                                    <small class="text-muted">
                                                        Podés usar el mismo que el de login o uno distinto.
                                                    </small>
                                                </div>
                                            </div>

                                            <div class="col-md-6">
                                                <div class="mb-3">
                                                    <label for="input-telefono" class="form-label">Teléfono de
                                                        contacto</label>
                                                    <input type="text" class="form-control" id="input-telefono"
                                                        placeholder="+54 9 ...">
                                                </div>
                                            </div>
                                        </div>

                                        <div class="mb-3">
                                            <label for="input-foto-url" class="form-label">URL de foto de
                                                perfil</label>
                                            <input type="url" class="form-control" id="input-foto-url"
                                                placeholder="https://...">
                                            <small class="text-muted">
                                                Por ahora usás una URL de imagen. Más adelante se puede agregar subida
                                                de archivo.
                                            </small>
                                        </div>

                                        <div class="d-flex justify-content-end">
                                            <button type="button" class="btn btn-primary" id="btn-guardar-perfil">
                                                <i class="mdi mdi-content-save me-1"></i> Guardar cambios
                                            </button>
                                        </div>
                                    </form>

                                    <div id="alerta-perfil" class="alert mt-3 d-none" role="alert"></div>
                                </div>
                            </div>
                        </div>

                        <!-- Columna derecha opcional -->
                        <div class="col-xl-4 col-lg-3">
                            <div class="card">
                                <div class="card-body">
                                    <h5 class="card-title mb-3">Ayuda</h5>
                                    <p class="text-muted mb-2">
                                        Acá podés:
                                    </p>
                                    <ul class="list-unstyled text-muted mb-0">
                                        <li class="py-1">
                                            • Actualizar tu nombre visible en la plataforma.
                                        </li>
                                        <li class="py-1">
                                            • Definir el email y teléfono que querés mostrar.
                                        </li>
                                        <li class="py-1">
                                            • Cambiar la foto de perfil usando una URL de imagen.
                                        </li>
                                    </ul>
                                </div>
                            </div>
                        </div>
                    </div>
                    <!-- end row -->

                </div> <!-- container-fluid -->
            </div>
            <!-- End Page-content -->

            <footer class="footer">
                <div class="container-fluid">
                    <div class="row">
                        <div class="col-sm-6">
                            <script>document.write(new Date().getFullYear())</script> © Imalá.
                        </div>
                        <div class="col-sm-6">
                            <div class="text-sm-end d-none d-sm-block">
                                Sistema de gestión de agentes.
                            </div>
                        </div>
                    </div>
                </div>
            </footer>
        </div>
        <!-- end main content-->

    </div>
    <!-- END layout-wrapper -->

    <!-- Right bar overlay-->
    <div class="rightbar-overlay"></div>

    <!-- JAVASCRIPT -->
    <script src="assets/libs/jquery/jquery.min.js"></script>
    <script src="assets/libs/bootstrap/js/bootstrap.bundle.min.js"></script>
    <script src="assets/libs/metismenu/metisMenu.min.js"></script>
    <script src="assets/libs/simplebar/simplebar.min.js"></script>
    <script src="assets/libs/node-waves/waves.min.js"></script>
    <script src="assets/libs/feather-icons/feather.min.js"></script>
    <script src="assets/libs/pace-js/pace.min.js"></script>
    <script src="assets/js/app.js"></script>

    <!-- PERFIL: Firebase + Firestore -->
    <script type="module">
        import {
            getAuth,
            onAuthStateChanged,
            updateProfile
        } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-auth.js";
        import {
            getFirestore,
            doc,
            getDoc,
            setDoc
        } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-firestore.js";
        import { app } from "./firebase-config.js";

        const auth = getAuth(app);
        const db = getFirestore(app);

        const $ = (id) => document.getElementById(id);
        const alerta = $("alerta-perfil");

        function showAlert(tipo, mensaje) {
            alerta.className = "alert alert-" + tipo + " mt-3";
            alerta.textContent = mensaje;
            alerta.classList.remove("d-none");
        }

        function actualizarAvatarPreview(url) {
            const avatarMain = document.getElementById("profile-avatar");
            const fallback = "assets/images/users/avatar-2.jpg";
            const src = url || fallback;
            if (avatarMain) avatarMain.src = src;
        }

        onAuthStateChanged(auth, async (user) => {
            if (!user) {
                window.location.href = "login.html";
                return;
            }

            // Header
            const headerNameEl = document.getElementById("header-user-name");
            const headerAvatarEl = document.getElementById("header-avatar");
            if (headerNameEl) {
                headerNameEl.textContent = user.displayName || (user.email ? user.email.split("@")[0] : "Agente");
            }
            if (headerAvatarEl && user.photoURL) {
                headerAvatarEl.src = user.photoURL;
            }

            // Email login
            if ($("input-email-login")) {
                $("input-email-login").value = user.email || "";
            }

            // Cargar perfil desde colección "usuarios/{uid}"
            try {
                const ref = doc(db, "usuarios", user.uid);
                const snap = await getDoc(ref);
                let data;

                if (snap.exists()) {
                    data = snap.data();
                } else {
                    data = {
                        nombre: user.displayName || "",
                        emailContacto: user.email || "",
                        telefono: "",
                        fotoUrl: user.photoURL || "",
                        emailAuth: user.email || "",
                        creadoEn: new Date().toISOString()
                    };
                    await setDoc(ref, data, { merge: true });
                }

                $("input-nombre").value = data.nombre || (user.displayName || "");
                $("input-email-contacto").value = data.emailContacto || (user.email || "");
                $("input-telefono").value = data.telefono || "";
                $("input-foto-url").value = data.fotoUrl || (user.photoURL || "");

                $("profile-name").textContent = $("input-nombre").value || "Agente";
                $("profile-email").textContent = user.email || data.emailContacto || "";

                actualizarAvatarPreview(data.fotoUrl || user.photoURL);

            } catch (err) {
                console.error(err);
                showAlert("danger", "No se pudo cargar tu perfil. Probá recargar la página.");
            }

            // Guardar cambios
            $("btn-guardar-perfil").addEventListener("click", async () => {
                const nombre = $("input-nombre").value.trim();
                const emailContacto = $("input-email-contacto").value.trim();
                const telefono = $("input-telefono").value.trim();
                const fotoUrl = $("input-foto-url").value.trim();

                if (!nombre) {
                    showAlert("warning", "El nombre es obligatorio.");
                    return;
                }

                const btn = $("btn-guardar-perfil");
                btn.disabled = true;
                btn.innerHTML = '<i class="bx bx-loader bx-spin me-1"></i> Guardando...';

                try {
                    const ref = doc(db, "usuarios", user.uid);
                    await setDoc(ref, {
                        nombre,
                        emailContacto,
                        telefono,
                        fotoUrl,
                        actualizadoEn: new Date().toISOString()
                    }, { merge: true });

                    // Actualizar perfil de Auth (displayName y photoURL)
                    await updateProfile(user, {
                        displayName: nombre,
                        photoURL: fotoUrl || null
                    });

                    $("profile-name").textContent = nombre;
                    $("profile-email").textContent = user.email || emailContacto;
                    actualizarAvatarPreview(fotoUrl || user.photoURL);

                    if (headerNameEl) headerNameEl.textContent = nombre;
                    if (headerAvatarEl && (fotoUrl || user.photoURL)) {
                        headerAvatarEl.src = fotoUrl || user.photoURL;
                    }

                    showAlert("success", "Perfil actualizado correctamente.");
                } catch (e) {
                    console.error(e);
                    showAlert("danger", "Ocurrió un error al guardar tu perfil.");
                } finally {
                    btn.disabled = false;
                    btn.innerHTML = '<i class="mdi mdi-content-save me-1"></i> Guardar cambios';
                }
            });

            // Preview en vivo de la foto cuando se escribe la URL
            $("input-foto-url").addEventListener("input", (e) => {
                const url = e.target.value.trim();
                actualizarAvatarPreview(url);
            });
        });
    </script>
</body>

</html>
