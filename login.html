<!doctype html>
<html lang="es">

<head>
    <meta charset="utf-8" />
    <title>Login | Imalá</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="shortcut icon" href="assets/images/imala.ico">
    
    <link href="assets/css/bootstrap.min.css" id="bootstrap-style" rel="stylesheet" type="text/css" />
    <link href="assets/css/icons.min.css" rel="stylesheet" type="text/css" />
    <link href="assets/css/app.min.css" id="app-style" rel="stylesheet" type="text/css" />

    <style>
        .auth-bg {
            background-image: url('assets/images/banner1.webp') !important;
            background-size: cover !important;
            background-position: center !important;
            background-blend-mode: overlay; 
        }
    </style>
</head>

<body>
    <div class="auth-page">
        <div class="container-fluid p-0">
            <div class="row g-0">
                
                <div class="col-xxl-3 col-lg-4 col-md-5">
                    <div class="auth-full-page-content d-flex p-sm-5 p-4">
                        <div class="w-100">
                            <div class="d-flex flex-column h-100">
                                
                                <div class="mb-4 mb-md-5 text-center">
                                    <a href="index.html" class="d-block auth-logo">
                                        <img src="assets/images/logo-imala.png" alt="" height="50"> 
                                    </a>
                                </div>

                                <div class="auth-content my-auto">
                                    <div class="text-center">
                                        <h5 class="mb-0">¡Bienvenido!</h5>
                                        <p class="text-muted mt-2">Ingresa tus datos para continuar.</p>
                                    </div>
                                    
                                    <form class="mt-4 pt-2">
                                        <div class="mb-3">
                                            <label class="form-label">Email</label>
                                            <input type="text" class="form-control" id="email" placeholder="tu@email.com">
                                        </div>
                                        <div class="mb-3">
                                            <div class="d-flex align-items-start">
                                                <div class="flex-grow-1">
                                                    <label class="form-label">Contraseña</label>
                                                </div>
                                                <div class="flex-shrink-0">
                                                    <div class="">
                                                        <a href="recover.html" class="text-muted">¿Olvidaste tu contraseña?</a>
                                                    </div>
                                                </div>
                                            </div>
                                            
                                            <div class="input-group auth-pass-inputgroup">
                                                <input type="password" class="form-control" id="password" placeholder="Ingresa tu contraseña" aria-label="Password" aria-describedby="password-addon">
                                                <button class="btn btn-light shadow-none ms-0" type="button" id="password-addon"><i class="mdi mdi-eye-outline"></i></button>
                                            </div>
                                        </div>
                                        
                                        <div class="mb-3">
                                            <button class="btn btn-primary w-100 waves-effect waves-light" type="button" id="btn-login">Iniciar Sesión</button>
                                        </div>
                                    </form>

                                    <div class="mt-4 pt-2 text-center">
                                        <div class="signin-other-title">
                                            <h5 class="font-size-14 mb-3 text-muted fw-medium">- Iniciar sesión con -</h5>
                                        </div>

                                        <ul class="list-inline mb-0">
                                            <li class="list-inline-item">
                                                <a href="javascript:void(0)" id="btn-google-login"
                                                    class="social-list-item bg-danger text-white border-danger">
                                                    <i class="mdi mdi-google"></i>
                                                </a>
                                            </li>
                                        </ul>
                                    </div>

                                    <div class="mt-5 text-center">
                                        <p class="text-muted mb-0">¿No tienes cuenta? <a href="register.html"
                                                class="text-primary fw-semibold"> Regístrate aquí </a> </p>
                                    </div>
                                </div>
                                
                                <div class="mt-4 mt-md-5 text-center">
                                    <p class="mb-0">© <script>document.write(new Date().getFullYear())</script> Imalá.</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="col-xxl-9 col-lg-8 col-md-7">
                    <div class="auth-bg pt-md-5 p-4 d-flex">
                        <div class="bg-overlay bg-primary"></div>
                        <ul class="bg-bubbles"><li></li><li></li><li></li><li></li><li></li><li></li><li></li><li></li><li></li><li></li></ul>
                        
                        <div class="row justify-content-center align-items-center">
                            <div class="col-xl-7">
                                <div class="p-0 p-sm-4 px-xl-0">
                                    
                                    <div id="reviewcarouselIndicators" class="carousel slide" data-bs-ride="carousel">
                                        <div class="carousel-indicators carousel-indicators-rounded justify-content-start ms-0 mb-0">
                                            <button type="button" data-bs-target="#reviewcarouselIndicators" data-bs-slide-to="0" class="active" aria-current="true" aria-label="Slide 1"></button>
                                            <button type="button" data-bs-target="#reviewcarouselIndicators" data-bs-slide-to="1" aria-label="Slide 2"></button>
                                            <button type="button" data-bs-target="#reviewcarouselIndicators" data-bs-slide-to="2" aria-label="Slide 3"></button>
                                        </div>
                                        
                                        <div class="carousel-inner">
                                            
                                            <div class="carousel-item active">
                                                <div class="testi-contain text-white">
                                                    <i class="bx bxs-quote-alt-left text-success display-6"></i>
                                                    <h4 class="mt-4 fw-medium lh-base text-white">
                                                        "Lo que no se mide, no se puede mejorar. Tu planificación es el mapa de tu éxito."
                                                    </h4>
                                                    <div class="mt-4 pt-3 pb-5">
                                                        <div class="d-flex align-items-start">
                                                            <div class="flex-grow-1 ms-3 mb-4">
                                                                <h5 class="font-size-18 text-white">David Tello</h5>
                                                                <p class="mb-0 text-white-50">Coach y programador</p>
                                                            </div>
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>

                                            <div class="carousel-item">
                                                <div class="testi-contain text-white">
                                                    <i class="bx bxs-quote-alt-left text-success display-6"></i>
                                                    <h4 class="mt-4 fw-medium lh-base text-white">
                                                        "El éxito mental comienza con la claridad. Definir tus metas es el primer paso para hacerlas realidad."
                                                    </h4>
                                                    <div class="mt-4 pt-3 pb-5">
                                                        <div class="d-flex align-items-start">
                                                            <div class="flex-grow-1 ms-3 mb-4">
                                                                <h5 class="font-size-18 text-white">Lucre Quattrocchio</h5>
                                                                <p class="mb-0 text-white-50">Psicóloga y coach</p>
                                                            </div>
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>

                                            <div class="carousel-item">
                                                <div class="testi-contain text-white">
                                                    <i class="bx bxs-quote-alt-left text-success display-6"></i>
                                                    <h4 class="mt-4 fw-medium lh-base text-white">
                                                        "La disciplina de registrar tus avances es lo que separa un deseo de un objetivo cumplido."
                                                    </h4>
                                                    <div class="mt-4 pt-3 pb-5">
                                                        <div class="d-flex align-items-start">
                                                            <div class="flex-grow-1 ms-3 mb-4">
                                                                <h5 class="font-size-18 text-white">David Tello</h5>
                                                                <p class="mb-0 text-white-50">Coach y programador</p>
                                                            </div>
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>

                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
            </div>
        </div>
    </div>

    <script src="assets/libs/jquery/jquery.min.js"></script>
    <script src="assets/libs/bootstrap/js/bootstrap.bundle.min.js"></script>
    <script src="assets/libs/metismenu/metisMenu.min.js"></script>
    <script src="assets/libs/simplebar/simplebar.min.js"></script>
    <script src="assets/libs/node-waves/waves.min.js"></script>
    <script src="assets/libs/feather-icons/feather.min.js"></script>
    <script src="assets/libs/pace-js/pace.min.js"></script>
    <script src="assets/js/pages/pass-addon.init.js"></script>

    <script type="module">
        import { getAuth, signInWithEmailAndPassword, signInWithPopup, GoogleAuthProvider, signOut } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-auth.js";
        import { getFirestore, doc, getDoc } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-firestore.js";
        import { app } from "./firebase-config.js";

        const auth = getAuth(app);
        const db = getFirestore(app);
        const googleProvider = new GoogleAuthProvider();

        // Verificar existencia de perfil con rol
        async function verificarUsuarioRegistradoUid(uid) {
            const usuarioRef = doc(db, "usuarios", uid);
            const usuarioSnap = await getDoc(usuarioRef);
            return usuarioSnap.exists() && usuarioSnap.data().rol;
        }

// LOGIN POR EMAIL
        document.getElementById("btn-login").addEventListener("click", async () => {
            const email = document.getElementById("email").value;
            const password = document.getElementById("password").value;

            if (!email || !password) { 
                alert("Ingresa email y contraseña"); 
                return; 
            }

            try {
                const userCredential = await signInWithEmailAndPassword(auth, email, password);
                const user = userCredential.user;

                // 1. Verificamos SIEMPRE en la base de datos, sin excepciones hardcodeadas
                const estaRegistradoUid = await verificarUsuarioRegistradoUid(user.uid);

                if (estaRegistradoUid) {
                    window.location.href = "index.html";
                } else {
                    await signOut(auth);
                    alert("⚠️ Esta cuenta no está registrada en el sistema. Por favor ve a 'Regístrate aquí' para seleccionar tu Oficina primero.");
                }
            } catch (error) {
                console.error(error);
                if (error.code === 'auth/invalid-credential' || error.code === 'auth/wrong-password' || error.code === 'auth/user-not-found') {
                    alert("❌ Credenciales incorrectas. Verifica tu email y contraseña.");
                } else {
                    alert("❌ Error: " + error.message);
                }
            }
        });

        // LOGIN CON GOOGLE
        document.getElementById("btn-google-login").addEventListener("click", async () => {
            try {
                const result = await signInWithPopup(auth, googleProvider);
                const user = result.user;

                // 1. Verificamos SIEMPRE en la base de datos
                const estaRegistradoUid = await verificarUsuarioRegistradoUid(user.uid);

                if (estaRegistradoUid) {
                    window.location.href = "index.html";
                } else {
                    await signOut(auth);
                    alert("⚠️ Esta cuenta de Google no está registrada en el sistema. Por favor ve a 'Regístrate aquí' para seleccionar tu Oficina primero.");
                }
            } catch (error) {
                console.error(error);
                alert("❌ Error con Google: " + error.message);
            }
        });

    </script>
</body>
</html>

